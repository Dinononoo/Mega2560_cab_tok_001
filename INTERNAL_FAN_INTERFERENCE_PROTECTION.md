# ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏ö‡∏Å‡∏ß‡∏ô Internal Fan ‡∏à‡∏≤‡∏Å Relay ‡∏≠‡∏∑‡πà‡∏ô‡πÜ

## ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö
Internal Fan ‡πÉ‡∏ä‡πâ Ultra-Precise Timing ‡πÅ‡∏ï‡πà‡πÇ‡∏î‡∏ô‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏à‡∏≤‡∏Å relay ‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô

## ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤
1. **Mega ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ K6, K7** ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô K5 (Internal Fan)
2. **ESP32 ‡∏™‡πà‡∏á RELAY command ‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ** ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏£‡∏ö‡∏Å‡∏ß‡∏ô Internal Fan
3. **‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡πÑ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô K5** ‡∏à‡∏≤‡∏Å relay command ‡∏≠‡∏∑‡πà‡∏ô‡πÜ

## ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

### 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Mega - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô K5 (Internal Fan)

#### 1.1 ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô K5 ‡∏à‡∏≤‡∏Å RELAY command
```cpp
// ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° relay ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÅ‡∏ï‡πà‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô K5, K6, K7 ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Ultra-Precise Timing
if (fanCycleActive || ecPumpRunning || phPumpRunning) {
  Serial.println("üîí Ultra-Precise devices active - Protecting K5/K6/K7 (Fan:" + String(fanCycleActive) + ", EC:" + String(ecPumpRunning) + ", PH:" + String(phPumpRunning) + ")");
}
```

#### 1.2 ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ K5 ‡∏ï‡∏≤‡∏° cycle state
```cpp
// ‡∏ñ‡πâ‡∏≤ Internal Fan ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ K5 (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà 4)
if (fanCycleActive && relayPattern.charAt(4) != (fanCycleState ? '1' : '0')) {
  protectedPattern.setCharAt(4, fanCycleState ? '1' : '0'); // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ K5 ‡∏ï‡∏≤‡∏° cycle state
  Serial.println("üîí Protected K5 (Internal Fan) - kept " + String(fanCycleState ? "ON" : "OFF") + " during Ultra-Precise timing");
  patternModified = true;
}
```

### 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ESP32 - ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á RELAY command

#### 2.1 ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏à‡∏≤‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏õ‡πá‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
```cpp
// ‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á relay ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏ö‡∏Å‡∏ß‡∏ô Ultra-Precise Timing
static unsigned long lastRelayCommand = 0;
if (millis() - lastRelayCommand >= 30000) { // ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
```

#### 2.2 ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Internal Fan ‡πÉ‡∏ô debug message
```cpp
// ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á relay ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Mega ‡∏à‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô K5, K6, K7 ‡πÄ‡∏≠‡∏á)
if (controlSettings.internal_fan_enabled || megaEcPumpRunning || megaPhPumpRunning) {
  Serial.println("üîí Ultra-Precise devices active - Mega protecting K5/K6/K7 (Fan:" + String(controlSettings.internal_fan_enabled ? "ON" : "OFF") + ", EC:" + String(megaEcPumpRunning) + ", PH:" + String(megaPhPumpRunning) + ")");
}
```

#### 2.3 ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á debug message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Internal Fan
```cpp
Serial.println("üåÄ Internal Fan Debug:");
Serial.println("   - Command sent: K5=" + String(currentRelayCommand.charAt(10)) + " (Protected by Mega)");
Serial.println("   - Expected state: " + String(fan_internal_state ? "ON" : "OFF"));
Serial.println("   - Delay ON: " + String(controlSettings.internal_fan_delay_on) + "s");
Serial.println("   - Delay OFF: " + String(controlSettings.internal_fan_delay_off) + "s");
Serial.println("   - Ultra-Precise Timing: Mega handles K5 control");
```

## ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

### 1. ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Internal Fan ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (fanCycleActive = true)
1. Mega ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ K5 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ Ultra-Precise Timing
2. ‡∏´‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö RELAY command ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô K5
3. Mega ‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ K5 ‡∏ï‡∏≤‡∏° cycle state ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
4. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤ "Protected K5 (Internal Fan)"

### 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠ EC/PH Pump ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
1. Mega ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô K6, K7 ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
2. ‡∏´‡∏≤‡∏Å Internal Fan ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡∏à‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô K5 ‡∏î‡πâ‡∏ß‡∏¢
3. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤ "Protecting K5/K6/K7"

### 3. ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á RELAY command ‡∏à‡∏≤‡∏Å ESP32
1. ESP32 ‡∏™‡πà‡∏á RELAY command ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÅ‡∏ó‡∏ô 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
2. Mega ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô K5, K6, K7
3. ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ relay ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô Ultra-Precise Timing

## ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

1. **‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏ö‡∏Å‡∏ß‡∏ô**: K5 (Internal Fan) ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏à‡∏≤‡∏Å relay command ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
2. **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á**: Ultra-Precise Timing ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏ö‡∏Å‡∏ß‡∏ô
3. **‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á**: ‡∏™‡πà‡∏á RELAY command ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏ó‡∏ô 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
4. **‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏µ**: ‡∏°‡∏µ debug messages ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
5. **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£**: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡πÅ‡∏°‡πâ‡∏°‡∏µ relay ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

## ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö

### 1. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô K5
1. ‡πÄ‡∏õ‡∏¥‡∏î Internal Fan ‡∏ú‡πà‡∏≤‡∏ô MQTT
2. ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á RELAY ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏¥‡∏î K5
3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ K5 ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏° cycle state

### 2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
1. ‡πÄ‡∏õ‡∏¥‡∏î Internal Fan ‡∏Å‡∏±‡∏ö delay 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
2. ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î relay ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Internal Fan ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Internal Fan ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î

### 3. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á
1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ESP32 ‡∏™‡πà‡∏á RELAY command ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Mega ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô K5 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

## ‡∏™‡∏£‡∏∏‡∏õ

‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ Internal Fan ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏à‡∏≤‡∏Å relay ‡∏≠‡∏∑‡πà‡∏ô‡πÜ:

- **Mega ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô K5** ‡∏à‡∏≤‡∏Å RELAY command ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
- **ESP32 ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà** ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á RELAY command
- **Ultra-Precise Timing** ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£
- **‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô** ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ
